name: API tests

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  api:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Install backend deps
        working-directory: backend
        run: poetry install

      - name: Start backend (SQLite)
        working-directory: backend
        env:
          DATABASE_URL: sqlite+aiosqlite:///./test.db
          SECRET_KEY: dev-secret-key
          TOKEN_ENCRYPTION_ALGORITHM: HS256
          ACCESS_TOKEN_EXPIRE_MINUTES: "30"
          REFRESH_TOKEN_EXPIRE_DAYS: "7"
        run: |
          export PYTHONPATH="$PWD/src"
          nohup poetry run python -m uvicorn main:app --host 127.0.0.1 --port 4322 > backend.log 2>&1 &

      - name: Wait for backend
        run: |
          python - <<'PY'
          import time, sys, requests
          url="http://127.0.0.1:4322/docs"
          for _ in range(60):
              try:
                  if requests.get(url, timeout=2).status_code == 200:
                      print("Backend is up")
                      sys.exit(0)
              except Exception:
                  pass
              time.sleep(1)
          print("Backend did not start")
          sys.exit(1)
          PY
          PY

      - name: Install API test deps
        run: pip install -r test/api-tests/requirements.txt

      - name: Run Robot API tests
        working-directory: test/api-tests
        run: robot -d results tests

      - name: Upload API results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-results
          path: test/api-tests/results

      - name: Upload backend log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-log-api
          path: backend/backend.log
